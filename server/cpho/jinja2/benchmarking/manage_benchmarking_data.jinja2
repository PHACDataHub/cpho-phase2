{% extends 'base.jinja2' %}
{% import 'breadcrumb_macros.jinja2' as bc %}

{% block content_breadcrumbs %}
  {{ bc.indicators_index() }}
  {{ bc.indicator(view.indicator) }}
  {{ bc.item(tm("benchmarking") , None, True) }}
{% endblock %}

{% macro benchmarking_form_field_with_errors(form,field,row_label_id) %}
  {{ field.as_widget(attrs={"aria-labelledby": row_label_id}) }}
  {% if field.errors %}
    <div class="error-display" id="{{ form.error_id_for_field(field) }}">
      {% for error in field.errors %}<strong>{{ error|escape }}</strong>{% endfor %}
    </div>
  {% endif %}
{% endmacro %}

{% macro benchmarking_form(form) %}
  {% set row_label_id = form.prefix ~ "-row-label" %}
  <tr class="benchmarking-form">
    <td>
      {{ benchmarking_form_field_with_errors(form,form.oecd_country, row_label_id) }}
      <span id="{{ row_label_id }}" class="visually-hidden">
        <span class="country-name"></span>
      </span>
    </td>
    <td>{{ benchmarking_form_field_with_errors(form,form.value, row_label_id) }}</td>
    <td>{{ form.unit.as_widget(attrs={"aria-labelledby": row_label_id}) }}</td>
    <td>{{ benchmarking_form_field_with_errors(form,form.year, row_label_id) }}</td>
    {# <td>{{ benchmarking_form_field_with_errors(form.standard_deviation) }}</td> #}
    <td>{{ benchmarking_form_field_with_errors(form, form.comparison_to_oecd_avg, row_label_id) }}</td>
    <td>{{ form.labels.as_widget(attrs={"aria-labelledby": row_label_id}) }}</td>
    <td>{{ form.methodology_differences.as_widget(attrs={"aria-labelledby": row_label_id}) }}</td>
    <td>
      {{ form.is_deleted.as_widget(attrs={"aria-labelledby": row_label_id}) }}
      {{ form.id }}
    </td>
  </tr>
{% endmacro %}

{% block content %}
  <div class="h2">{{ tm("benchmarking_metadata") }} {{ tm("for") }} : {{ indicator.bilingual_name }}</div>

  <a class="btn btn-primary"
     href="{{ url('export_benchmarking', args=[indicator.id]) }}">{{ tm("export_benchmarking") }}</a>

  <div class="table-responsive">

    <table class="d-none benchmarking-empty-form-container">
      {{ benchmarking_form(benchmarking_formset.empty_form) }}
    </table>
  </div>
  <form action="." method="post">
    {{ benchmarking_formset.management_form }}
    {{ csrf_input }}

    <div class="table-responsive">

      <table class="table mt-3"
             id="benchmarking-table"
             style="overflow-x:auto;
                    display:block">
        <thead>
          <tr>
            <th>{{ tm("oecd_country") }}</th>
            <th>{{ tm("value") }}</th>
            <th>{{ tm("unit") }}</th>
            <th>{{ tm("year") }}</th>
            {# <th>{{ tdt("Standard Deviation") }}</th> #}
            <th>{{ tm("comparison_to_oecd_average") }}</th>
            <th>{{ tm("labels") }}</th>
            <th>{{ tm("methodology_differences") }}</th>
            <th>{{ tm("delete") }}</th>
          </tr>
        </thead>
        <tbody id="benchmarking-table-body"
               class="text-center benchmarking-form-list">
          {% for form in benchmarking_formset %}{{ benchmarking_form(form) }}{% endfor %}
        </tbody>
      </table>
    </div>
    {% if benchmarking_formset.non_form_errors() %}
      <div class="error-div">{{ benchmarking_formset.non_form_errors() }}</div>
    {% endif %}
    {% if respects_rule('can_edit_benchmarking', indicator) %}
      <div class="text-center py-1">
        <button type="button" class="btn btn-primary btn-sm px-4" id="add-form">{{ tm("add_data") }}</button>
      </div>
      <input type="submit"
             class="btn btn-primary float-end my-3"
             value="{{ tm('save') }}">
    {% endif %}
  </form>

  <script src="{{ static('js/manage_benchmarking_scripts.js') }}"
          type="text/javascript"></script>

{% endblock %}
