{% extends 'base.jinja2' %}
{% import 'breadcrumb_macros.jinja2' as bc %}

{% block content_breadcrumbs %}
  {{ bc.indicators_index() }}
  {{ bc.indicator(view.indicator) }}
  {{ bc.indicator_period(view.indicator, period) }}
  {{ bc.item(tdt("Edit") , None, True) }}
{% endblock %}

{% macro age_group_form(form) %}
  <tr class="age-group-form">
    <td class="fw-bold">{{ form.literal_dimension_val }}</td>
    <td>
      {{ form.value }}
      {% if form.errors.value %}
        {% for error in form.value.errors %}<strong>{{ error|escape }}</strong>{% endfor %}
      {% endif %}
    </td>
    <td>{{ form.value_unit }}</td>
    <td>
      {{ form.value_lower_bound }}
      {% if form.errors.value_lower_bound %}
        {% for error in form.value_lower_bound.errors %}<strong>{{ error|escape }}</strong>{% endfor %}
      {% endif %}
    </td>
    <td>
      {{ form.value_upper_bound }}
      {% if form.errors.value_upper_bound %}
        {% for error in form.value_upper_bound.errors %}<strong>{{ error|escape }}</strong>{% endfor %}
      {% endif %}
    </td>
    <td>{{ form.data_quality }}</td>
    <td>
      {{ form.single_year_timeframe }}
      {% if form.errors.single_year_timeframe %}
        {% for error in form.single_year_timeframe.errors %}<strong>{{ error|escape }}</strong>{% endfor %}
      {% endif %}
    </td>
    <td>
      {{ form.multi_year_timeframe }}
      {% if form.errors.value_lower_bound %}
        {% for error in form.value_lower_bound.errors %}<strong>{{ error|escape }}</strong>{% endfor %}
      {% endif %}
    </td>
    <td>{{ form.value_displayed }}</td>
    <td>{{ form.reason_for_null }}</td>
    <td>
      {{ form.id }} {# this is hidden #}
      {{ form.is_deleted }}
    </td>
  </tr>
{% endmacro %}

{% block content %}
  <h1>{{ tdt("Indicator data for: ") }} {{ indicator.name }} ({{ period }})</h1>
  <a class="btn btn-warning btn-sm"
     href="{{ url('view_indicator_for_period', args=[indicator.id, period.id]) }}">Cancel</a>

  <table class="d-none age-group-empty-form-container">
    {# This is a form template to be used by 'add new form' feature #}
    {# Parent must be a table, otherwise browser will strip the invalid tr/td tags #}
    {{ age_group_form(age_group_formset.empty_form) }}
  </table>

  {# TODO: display form errors?  #}
  <form action="." method="post">
    {{ predefined_values_formset.management_form }}
    {{ age_group_formset.management_form }}
    {{ csrf_input }}
    {% for dimension_type in predefined_dimension_types %}
      <div class="card mt-5 mb-2">
        <div class="card-header">
          <div class="h3">{{ tdt("Managing data for stratifier: ") }} {{ dimension_type.name }}</div>
        </div>
 
        <table class="table mb-0"
               id="{{ dimension_type }}-table"
               style="overflow-x:auto;
                      display:block">
          <thead class="table-light text-center">
            <tr>
              <th width="10%">{{ dimension_type.name }}</th>
              <th width="9%">{{ tdt("Value") }}</th>
              <th width="9%">{{ tdt("Value Unit") }}</th>
              <th width="9%">{{ tdt("Value Lower Bound") }}</th>
              <th width="9%">{{ tdt("Value Upper Bound") }}</th>
              <th width="9%">{{ tdt("Data Quality") }}</th>
              <th width="9%">{{ tdt("Single Year Timeframe") }}</th>
              <th width="9%">{{ tdt("Multi Year Timeframe") }}</th>
              <th width="9%">{{ tdt("Value Displayed") }}</th>
              <th width="9%">{{ tdt("Reason For Null Data") }}</th>
            </tr>
          </thead>
          <tbody id="{{ dimension_type }}-table-body" class="text-center">
            {% for possible_value in possible_values_by_dimension_type[dimension_type] %}
              <tr>
                {% set form = forms_by_dimension_value[possible_value] %}
                <td class="fw-bold">{{ possible_value.name }}</td>
                <td>
                  {{ form.value }}
                  {% if form.errors.value %}
                    <div class="error-display">
                      {% for error in form.value.errors %}<strong>{{ error|escape }}</strong>{% endfor %}
                    </div>
                  {% endif %}
                </td>
                <td>{{ form.value_unit }}</td>
                <td>
                  {{ form.value_lower_bound }}
                  {% if form.errors.value_lower_bound %}
                    <div class="error-display">
                      {% for error in form.value_lower_bound.errors %}<strong>{{ error|escape }}</strong>{% endfor %}
                    </div>
                  {% endif %}
                </td>
                <td>
                  {{ form.value_upper_bound }}
                  {% if form.errors.value_upper_bound %}
                    <div class="error-display">
                      {% for error in form.value_upper_bound.errors %}<strong>{{ error|escape }}</strong>{% endfor %}
                    </div>
                  {% endif %}
                </td>
                <td>{{ form.data_quality }}</td>
                <td>
                  {{ form.single_year_timeframe }}
                  {% if form.errors.single_year_timeframe %}
                    <div class="error-display">
                      {% for error in form.single_year_timeframe.errors %}<strong>{{ error|escape }}</strong>{% endfor %}
                    </div>
                  {% endif %}
                </td>
                <td>
                  {{ form.multi_year_timeframe }}
                  {% if form.errors.multi_year_timeframe %}
                    <div class="error-display">
                      {% for error in form.multi_year_timeframe.errors %}<strong>{{ error|escape }}</strong>{% endfor %}
                    </div>
                  {% endif %}
                </td>
                <td>{{ form.value_displayed }}</td>
                <td>{{ form.reason_for_null }}</td>
              </tr>
            {% endfor %}

          </tbody>
        </table>
      </div>
    {% endfor %}
    {% if show_age_group %}
      <div class="card mt-5 mb-2">
        <div class="card-header">
          <div class="h3">{{ tdt("Managing data for stratifier: ") }} {{ tdt("Age") }}</div>
        </div>
 
        <table class="table mb-0"
               id="{{ dimension_type }}-table"
               style="overflow-x:auto;
                      display:block">
 
          <thead class="table-light text-center">
            <tr>
              <th width="9%">{{ tdt("Age") }}</th>
              <th width="9%">{{ tdt("Value") }}</th>
              <th width="9%">{{ tdt("Value Unit") }}</th>
              <th width="9%">{{ tdt("Value Lower Bound") }}</th>
              <th width="9%">{{ tdt("Value Upper Bound") }}</th>
              <th width="9%">{{ tdt("Data Quality") }}</th>
              <th width="9%">{{ tdt("Single Year Timeframe") }}</th>
              <th width="9%">{{ tdt("Multi Year Timeframe") }}</th>
              <th width="9%">{{ tdt("Value Displayed") }}</th>
              <th width="9%">{{ tdt("Reason For Null Data") }}</th>
              <th width="5%">{{ tdt("Delete") }}</th>
            </tr>
          </thead>
          <tbody id="{{ dimension_type }}-table-body"
                 class="text-center age-group-form-list">
            {% for form in age_group_formset %}{{ age_group_form(form) }}{% endfor %}
          </tbody>
        </table>
        <div class="text-center py-1">
          <button type="button" class="btn btn-primary btn-sm px-4" id="add-form">{{ tdt("Add another age group") }}</button>
        </div>
      </div>
    {% endif %}

    <input type="submit"
           class="btn btn-primary float-end my-3"
           value="{{ tdt("Save") }}">
  </form>

  {% if show_age_group %}
    <script>
  // this approach is documented here https://www.brennantymrak.com/articles/django-dynamic-formsets-javascript
  // changed a few things, like using an empty-form template
  let addButton = document.querySelector("#add-form")
  addButton.addEventListener('click', addForm)

  function addForm(e){
      /*
        copies innerHTML of empty form template, inserts new prefix
        appends new form to list, updates management form's input

      */ 
      let forms = document.querySelectorAll(".age-group-form-list > .age-group-form")
      let newFormIndex = forms.length; // starts at 0
      let numForms = forms.length + 1; //total forms after addition
      let formTemplateNode = document.querySelector(".age-group-empty-form-container")
      let container = document.querySelector(".age-group-form-list")
      let totalFormsInput = document.querySelector("#id_agegroup-TOTAL_FORMS") //management form inputs
      e.preventDefault()
      let formRegex = RegExp(`agegroup-__prefix__-`,'g')
      let newFormHtml = formTemplateNode.innerHTML.replace(formRegex, `agegroup-${newFormIndex}-`)
      let newForm = document.createElement("tr")
      newForm.classList.add("age-group-form")
      newForm.innerHTML = newFormHtml;
      container.appendChild(newForm)
      //newForm.outerHTML = `<tr class='age-group-form'>${newFormHtml}</tr>`;
      
      totalFormsInput.setAttribute('value', `${numForms}`)
  }
    </script>
  {% endif %}

{% endblock %}
